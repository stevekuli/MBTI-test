{"version":3,"file":"utils.js","sources":["../../../../taro-components-library-vue3/src/vue-component-lib/utils.ts"],"sourcesContent":["/**\n * Modify from https://github.com/ionic-team/stencil-ds-output-targets/blob/main/packages/vue-output-target/vue-component-lib/utils.ts\n * MIT License https://github.com/ionic-team/stencil-ds-output-targets/blob/main/LICENSE\n */\nimport { defineComponent, getCurrentInstance, h, inject, Ref, ref, VNode } from 'vue'\n\nexport interface InputProps<T> {\n  modelValue?: T\n}\n\nconst UPDATE_VALUE_EVENT = 'update:modelValue'\nconst MODEL_VALUE = 'modelValue'\nconst ROUTER_LINK_VALUE = 'routerLink'\nconst NAV_MANAGER = 'navManager'\nconst ROUTER_PROP_PREFIX = 'router'\nconst ARIA_PROP_PREFIX = 'aria'\n/**\n * Starting in Vue 3.1.0, all properties are\n * added as keys to the props object, even if\n * they are not being used. In order to correctly\n * account for both value props and v-model props,\n * we need to check if the key exists for Vue <3.1.0\n * and then check if it is not undefined for Vue >= 3.1.0.\n * See https://github.com/vuejs/vue-next/issues/3889\n */\nconst EMPTY_PROP = Symbol('EMPTY_PROP')\nconst DEFAULT_EMPTY_PROP = { default: EMPTY_PROP }\n\ninterface NavManager<T = any> {\n  navigate: (options: T) => void\n}\n\nconst getComponentClasses = (classes: unknown) => {\n  return (classes as string)?.split(' ') || []\n}\n\nconst getElementClasses = (\n  ref: Ref<HTMLElement | undefined>,\n  componentClasses: Set<string>,\n  defaultClasses: string[] = []\n) => {\n  return [...Array.from(ref.value?.classList || []), ...defaultClasses].filter(\n    (c: string, i, self) => !componentClasses.has(c) && self.indexOf(c) === i\n  )\n}\n\n/**\n * Create a callback to define a Vue component wrapper around a Web Component.\n *\n * @prop name - The component tag name (i.e. `ion-button`)\n * @prop componentProps - An array of properties on the\n * component. These usually match up with the @Prop definitions\n * in each component's TSX file.\n * @prop customElement - An option custom element instance to pass\n * to customElements.define. Only set if `includeImportCustomElements: true` in your config.\n * @prop modelProp - The prop that v-model binds to (i.e. value)\n * @prop modelUpdateEvent - The event that is fired from your Web Component when the value changes (i.e. ionChange)\n * @prop externalModelUpdateEvent - The external event to fire from your Vue component when modelUpdateEvent fires. This is used for ensuring that v-model references have been\n * correctly updated when a user's event callback fires.\n */\nexport const defineContainer = <Props, VModelType = string | number | boolean>(\n  name: string,\n  defineCustomElement: any,\n  componentProps: string[] = [],\n  modelProp?: string,\n  modelUpdateEvent?: string,\n  externalModelUpdateEvent?: string\n) => {\n  /**\n   * Create a Vue component wrapper around a Web Component.\n   * Note: The `props` here are not all properties on a component.\n   * They refer to whatever properties are set on an instance of a component.\n   */\n\n  if (!DEPRECATED_ADAPTER_COMPONENT && defineCustomElement !== undefined) {\n    defineCustomElement()\n  }\n\n  const Container = defineComponent<Props & InputProps<VModelType>>((props: any, { attrs, slots, emit }) => {\n    let modelPropValue = props[modelProp]\n    const containerRef = ref<HTMLElement>()\n    const classes = new Set(getComponentClasses(attrs.class))\n    const onVnodeBeforeMount = (vnode: VNode) => {\n      // Add a listener to tell Vue to update the v-model\n      if (vnode.el) {\n        const eventsNames = Array.isArray(modelUpdateEvent) ? modelUpdateEvent : [modelUpdateEvent]\n        eventsNames.forEach((eventName: string) => {\n          vnode.el!.addEventListener(eventName.toLowerCase(), (e: Event) => {\n            modelPropValue = (e?.target as any)[modelProp]\n            emit(UPDATE_VALUE_EVENT, modelPropValue)\n\n            /**\n             * We need to emit the change event here\n             * rather than on the web component to ensure\n             * that any v-model bindings have been updated.\n             * Otherwise, the developer will listen on the\n             * native web component, but the v-model will\n             * not have been updated yet.\n             */\n            if (externalModelUpdateEvent) {\n              emit(externalModelUpdateEvent, e)\n            }\n          })\n        })\n      }\n    }\n\n    const currentInstance = getCurrentInstance()\n    const hasRouter = currentInstance?.appContext?.provides[NAV_MANAGER]\n    const navManager: NavManager | undefined = hasRouter ? inject(NAV_MANAGER) : undefined\n    const handleRouterLink = (ev: Event) => {\n      const { routerLink } = props\n      if (routerLink === EMPTY_PROP) return\n\n      if (navManager !== undefined) {\n        const navigationPayload: any = { event: ev }\n        for (const key in props) {\n          const value = props[key]\n          if (props.hasOwnProperty(key) && key.startsWith(ROUTER_PROP_PREFIX) && value !== EMPTY_PROP) {\n            navigationPayload[key] = value\n          }\n        }\n\n        navManager.navigate(navigationPayload)\n      } else {\n        console.warn('Tried to navigate, but no router was found. Make sure you have mounted Vue Router.')\n      }\n    }\n\n    return () => {\n      modelPropValue = props[modelProp]\n\n      getComponentClasses(attrs.class).forEach((value) => {\n        classes.add(value)\n      })\n\n      const oldClick = props.onClick\n      const handleClick = (ev: Event) => {\n        if (oldClick !== undefined) {\n          oldClick(ev)\n        }\n        if (!ev.defaultPrevented) {\n          handleRouterLink(ev)\n        }\n      }\n\n      let propsToAdd: any = {\n        ref: containerRef,\n        class: getElementClasses(containerRef, classes),\n        onClick: (ev: Event) => {\n          handleClick(ev)\n          emit('tap', ev) // Note(taro): 为 click 事件绑定 tap 事件\n        },\n        onVnodeBeforeMount: modelUpdateEvent ? onVnodeBeforeMount : undefined,\n      }\n\n      /**\n       * We can use Object.entries here\n       * to avoid the hasOwnProperty check,\n       * but that would require 2 iterations\n       * where as this only requires 1.\n       */\n      for (const key in props) {\n        const value = props[key]\n        if ((props.hasOwnProperty(key) && value !== EMPTY_PROP) || key.startsWith(ARIA_PROP_PREFIX)) {\n          propsToAdd[key] = value\n        }\n      }\n\n      if (modelProp) {\n        /**\n         * If form value property was set using v-model\n         * then we should use that value.\n         * Otherwise, check to see if form value property\n         * was set as a static value (i.e. no v-model).\n         */\n        if (props[MODEL_VALUE] !== EMPTY_PROP) {\n          propsToAdd = {\n            ...propsToAdd,\n            [modelProp]: props[MODEL_VALUE],\n          }\n        } else if (modelPropValue !== EMPTY_PROP) {\n          propsToAdd = {\n            ...propsToAdd,\n            [modelProp]: modelPropValue,\n          }\n        }\n      }\n\n      return h(name, propsToAdd, slots.default && slots.default())\n    }\n  })\n\n  Container.displayName = name\n\n  Container.props = {\n    [ROUTER_LINK_VALUE]: DEFAULT_EMPTY_PROP,\n  }\n\n  componentProps.forEach((componentProp) => {\n    Container.props[componentProp] = DEFAULT_EMPTY_PROP\n  })\n\n  if (modelProp) {\n    Container.props[MODEL_VALUE] = DEFAULT_EMPTY_PROP\n    Container.emits = [UPDATE_VALUE_EVENT, externalModelUpdateEvent]\n  }\n\n  return Container\n}\n"],"names":[],"mappings":"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"}