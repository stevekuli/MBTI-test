{"version":3,"file":"createOverlayComponent.js","sources":["../../../../taro-components-library-react/src/react-component-lib/createOverlayComponent.tsx"],"sourcesContent":["/**\n * Modify from https://github.com/ionic-team/stencil-ds-output-targets/blob/main/packages/react-output-target/react-component-lib/createOverlayComponent.ts\n * MIT License https://github.com/ionic-team/stencil-ds-output-targets/blob/main/LICENSE\n */\nimport React from 'react'\nimport ReactDOM from 'react-dom'\n\nimport { OverlayEventDetail } from './interfaces'\nimport { attachProps, dashToPascalCase, defineCustomElement, setRef, StencilReactForwardedRef } from './utils'\n\ninterface OverlayElement extends HTMLElement {\n  present: () => Promise<void>\n  dismiss: (data?: any, role?: string | undefined) => Promise<boolean>\n}\n\nexport interface ReactOverlayProps {\n  children?: React.ReactNode\n  isOpen: boolean\n  onDidDismiss?: (event: CustomEvent<OverlayEventDetail>) => void\n  onDidPresent?: (event: CustomEvent<OverlayEventDetail>) => void\n  onWillDismiss?: (event: CustomEvent<OverlayEventDetail>) => void\n  onWillPresent?: (event: CustomEvent<OverlayEventDetail>) => void\n}\n\nexport const createOverlayComponent = <OverlayComponent extends object, OverlayType extends OverlayElement>(\n  tagName: string,\n  controller: { create: (options: any) => Promise<OverlayType> },\n  customElement?: any\n) => {\n  defineCustomElement(tagName, customElement)\n\n  const displayName = dashToPascalCase(tagName)\n  const didDismissEventName = `on${displayName}DidDismiss`\n  const didPresentEventName = `on${displayName}DidPresent`\n  const willDismissEventName = `on${displayName}WillDismiss`\n  const willPresentEventName = `on${displayName}WillPresent`\n\n  type Props = OverlayComponent &\n  ReactOverlayProps & {\n    forwardedRef?: StencilReactForwardedRef<OverlayType>\n  };\n\n  let isDismissing = false\n\n  class Overlay extends React.Component<Props> {\n    overlay?: OverlayType\n    el!: HTMLDivElement\n\n    constructor (props: Props) {\n      super(props)\n      if (typeof document !== 'undefined') {\n        this.el = document.createElement('div')\n      }\n      this.handleDismiss = this.handleDismiss.bind(this)\n    }\n\n    static get displayName () {\n      return displayName\n    }\n\n    componentDidMount () {\n      if (this.props.isOpen) {\n        this.present()\n      }\n    }\n\n    componentWillUnmount () {\n      if (this.overlay) {\n        this.overlay.dismiss()\n      }\n    }\n\n    handleDismiss (event: CustomEvent<OverlayEventDetail<any>>) {\n      if (this.props.onDidDismiss) {\n        this.props.onDidDismiss(event)\n      }\n      setRef(this.props.forwardedRef, null)\n    }\n\n    shouldComponentUpdate (nextProps: Props) {\n      // Check if the overlay component is about to dismiss\n      if (this.overlay && nextProps.isOpen !== this.props.isOpen && nextProps.isOpen === false) {\n        isDismissing = true\n      }\n\n      return true\n    }\n\n    async componentDidUpdate (prevProps: Props) {\n      if (this.overlay) {\n        attachProps(this.overlay, this.props, prevProps)\n      }\n\n      if (prevProps.isOpen !== this.props.isOpen && this.props.isOpen === true) {\n        this.present(prevProps)\n      }\n      if (this.overlay && prevProps.isOpen !== this.props.isOpen && this.props.isOpen === false) {\n        await this.overlay.dismiss()\n        isDismissing = false\n\n        /**\n         * Now that the overlay is dismissed\n         * we need to render again so that any\n         * inner components will be unmounted\n         */\n        this.forceUpdate()\n      }\n    }\n\n    async present (prevProps?: Props) {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { children, isOpen, onDidDismiss, onDidPresent, onWillDismiss, onWillPresent, ...cProps } = this.props\n      const elementProps = {\n        ...cProps,\n        ref: this.props.forwardedRef,\n        [didDismissEventName]: this.handleDismiss,\n        [didPresentEventName]: (e: CustomEvent) => this.props.onDidPresent && this.props.onDidPresent(e),\n        [willDismissEventName]: (e: CustomEvent) => this.props.onWillDismiss && this.props.onWillDismiss(e),\n        [willPresentEventName]: (e: CustomEvent) => this.props.onWillPresent && this.props.onWillPresent(e),\n      }\n\n      this.overlay = await controller.create({\n        ...elementProps,\n        component: this.el,\n        componentProps: {},\n      })\n\n      setRef(this.props.forwardedRef, this.overlay)\n      attachProps(this.overlay, elementProps, prevProps)\n\n      await this.overlay.present()\n    }\n\n    render () {\n      /**\n       * Continue to render the component even when\n       * overlay is dismissing otherwise component\n       * will be hidden before animation is done.\n       */\n      return ReactDOM.createPortal(this.props.isOpen || isDismissing ? this.props.children : null, this.el)\n    }\n  }\n\n  return React.forwardRef<OverlayType, Props>((props, ref) => {\n    // Note: 组件库错误引入 vue 的 ts 类型，导致 ts 报错，这里先忽略\n    // @ts-ignore\n    return <Overlay {...props} forwardedRef={ref} />\n  })\n}\n"],"names":[],"mappings":"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"}