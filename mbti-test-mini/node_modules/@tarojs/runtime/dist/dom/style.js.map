{"version":3,"file":"style.js","sources":["../../src/dom/style.ts"],"sourcesContent":["import { hooks, isArray, isNull, isString, isUndefined, Shortcuts, toCamelCase, toDashed, warn } from '@tarojs/shared'\n\nimport { PROPERTY_THRESHOLD } from '../constants'\nimport { MutationObserver, MutationRecordType } from '../dom-external/mutation-observer'\nimport { TaroElement } from './element'\nimport { styleProperties } from './style_properties'\n\nfunction recordCss (obj: Style) {\n  MutationObserver.record({\n    type: MutationRecordType.ATTRIBUTES,\n    target: obj._element,\n    attributeName: 'style',\n    oldValue: obj.cssText\n  })\n}\n\nfunction enqueueUpdate (obj: Style) {\n  const element = obj._element\n  if (element._root) {\n    element.enqueueUpdate({\n      path: `${element._path}.${Shortcuts.Style}`,\n      value: obj.cssText\n    })\n  }\n}\n\nfunction setStyle (this: Style, newVal: string, styleKey: string) {\n  process.env.NODE_ENV !== 'production' && warn(\n    isString(newVal) && newVal.length > PROPERTY_THRESHOLD,\n    `Style 属性 ${styleKey} 的值数据量过大，可能会影响渲染性能，考虑使用 CSS 类或其它方案替代。`\n  )\n\n  const old = this[styleKey]\n\n  if (old === newVal) return\n\n  !this._pending && recordCss(this)\n\n  if (isNull(newVal) || isUndefined(newVal) || newVal === '') {\n    this._usedStyleProp.delete(styleKey)\n    delete this._value[styleKey]\n  } else {\n    this._usedStyleProp.add(styleKey)\n    this._value[styleKey] = newVal\n  }\n\n  !this._pending && enqueueUpdate(this)\n}\n\nfunction initStyle (ctor: typeof Style, styleProperties: string[]) {\n  const properties = {}\n\n  for (let i = 0; i < styleProperties.length; i++) {\n    const styleKey = styleProperties[i]\n\n    if (ctor[styleKey]) return\n\n    properties[styleKey] = {\n      get (this: Style) {\n        const val = this._value[styleKey]\n        return isNull(val) || isUndefined(val) ? '' : val\n      },\n      set (this: Style, newVal: string) {\n        setStyle.call(this, newVal, styleKey)\n      }\n    }\n  }\n\n  Object.defineProperties(ctor.prototype, properties)\n}\n\nfunction isCssVariable (propertyName) {\n  return /^--/.test(propertyName)\n}\n\nexport class Style {\n  public _pending: boolean\n\n  public _usedStyleProp: Set<string>\n\n  public _value: Partial<CSSStyleDeclaration>\n\n  public _element: TaroElement\n\n  public constructor (element: TaroElement) {\n    this._element = element\n    this._usedStyleProp = new Set()\n    this._value = {}\n  }\n\n  private setCssVariables (styleKey: string) {\n    this.hasOwnProperty(styleKey) || Object.defineProperty(this, styleKey, {\n      enumerable: true,\n      configurable: true,\n      get: () => {\n        return this._value[styleKey] || ''\n      },\n      set: (newVal: string) => {\n        setStyle.call(this, newVal, styleKey)\n      }\n    })\n  }\n\n  public get cssText () {\n    if (!this._usedStyleProp.size) return ''\n\n    const texts: string[] = []\n    this._usedStyleProp.forEach(key => {\n      const val = this[key]\n      if (isNull(val) || isUndefined(val)) return\n      let styleName = isCssVariable(key) ? key : toDashed(key)\n      if (styleName.indexOf('webkit') === 0 || styleName.indexOf('Webkit') === 0) {\n        styleName = `-${styleName}`\n      }\n      texts.push(`${styleName}: ${val};`)\n    })\n    return texts.join(' ')\n  }\n\n  public set cssText (str: string) {\n    this._pending = true\n    recordCss(this)\n\n    this._usedStyleProp.forEach(prop => {\n      this.removeProperty(prop)\n    })\n\n    if (str === '' || isUndefined(str) || isNull(str)) {\n      this._pending = false\n      enqueueUpdate(this)\n      return\n    }\n\n    const rules = str.split(';')\n\n    for (let i = 0; i < rules.length; i++) {\n      const rule = rules[i].trim()\n      if (rule === '') {\n        continue\n      }\n\n      // 可能存在 'background: url(http:x/y/z)' 的情况\n      const [propName, ...valList] = rule.split(':')\n      const val = valList.join(':')\n\n      if (isUndefined(val)) {\n        continue\n      }\n      this.setProperty(propName.trim(), val.trim())\n    }\n\n    this._pending = false\n    enqueueUpdate(this)\n  }\n\n  public setProperty (propertyName: string, value?: string | null) {\n    if (propertyName[0] === '-') {\n      // 支持 webkit 属性或 css 变量\n      this.setCssVariables(propertyName)\n    } else {\n      propertyName = toCamelCase(propertyName)\n    }\n\n    if (isNull(value) || isUndefined(value)) {\n      this.removeProperty(propertyName)\n    } else {\n      this[propertyName] = value\n    }\n  }\n\n  public removeProperty (propertyName: string): string {\n    propertyName = toCamelCase(propertyName)\n    if (!this._usedStyleProp.has(propertyName)) {\n      return ''\n    }\n\n    const value = this[propertyName]\n    this[propertyName] = undefined\n    return value\n  }\n\n  public getPropertyValue (propertyName: string) {\n    propertyName = toCamelCase(propertyName)\n    const value = this[propertyName]\n    if (!value) {\n      return ''\n    }\n\n    return value\n  }\n}\n\ninitStyle(Style, styleProperties)\n\nhooks.tap('injectNewStyleProperties', (newStyleProperties: string[]) => {\n  if (isArray(newStyleProperties)) {\n    initStyle(Style, newStyleProperties)\n  } else {\n    if (typeof newStyleProperties !== 'string') return\n\n    initStyle(Style, [newStyleProperties])\n  }\n})\n"],"names":[],"mappings":"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"}