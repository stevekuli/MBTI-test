{"version":3,"file":"event-target.js","sources":["../../src/dom/event-target.ts"],"sourcesContent":["import { hooks, isArray, isObject, warn } from '@tarojs/shared'\n\nimport type { AddEventListenerOptions, EventHandler } from '../interface'\n\nexport class TaroEventTarget {\n  public __handlers: Record<string, EventHandler[]> = {}\n\n  public addEventListener (type: string, handler: EventHandler, options?: boolean | AddEventListenerOptions) {\n    type = type.toLowerCase()\n\n    hooks.call('onAddEvent', type, handler, options, this)\n\n    if (type === 'regionchange') {\n      // map 组件的 regionchange 事件非常特殊，详情：https://github.com/NervJS/taro/issues/5766\n      this.addEventListener('begin', handler, options)\n      this.addEventListener('end', handler, options)\n      return\n    }\n\n    let isCapture = Boolean(options)\n    let isOnce = false\n    if (isObject<AddEventListenerOptions>(options)) {\n      isCapture = Boolean(options.capture)\n      isOnce = Boolean(options.once)\n    }\n\n    if (isOnce) {\n      const wrapper = function () {\n        handler.apply(this, arguments) // this 指向 Element\n        this.removeEventListener(type, wrapper)\n      }\n      this.addEventListener(type, wrapper, {\n        ...(options as AddEventListenerOptions),\n        once: false\n      })\n      return\n    }\n\n    process.env.NODE_ENV !== 'production' && warn(isCapture, 'Taro 暂未实现 event 的 capture 特性。')\n\n    // 某些框架，如 PReact 有委托的机制，handler 始终是同一个函数\n    // 这会导致多层停止冒泡失败：view -> view(handler.stop = false) -> view(handler.stop = true)\n    // 这样解决：view -> view(handlerA.stop = false) -> view(handlerB.stop = false)\n    // 因此每次绑定事件都新建一个函数，如果带来了性能问题，可以把这段逻辑抽取到 PReact 插件中。\n    const oldHandler = handler\n    handler = function () {\n      return oldHandler.apply(this, arguments) // this 指向 Element\n    }\n    ;(handler as any).oldHandler = oldHandler\n\n    const handlers = this.__handlers[type]\n    if (isArray(handlers)) {\n      handlers.push(handler)\n    } else {\n      this.__handlers[type] = [handler]\n    }\n  }\n\n  public removeEventListener (type: string, handler: EventHandler) {\n    type = type.toLowerCase()\n\n    if (type === 'regionchange') {\n      // map 组件的 regionchange 事件非常特殊，详情：https://github.com/NervJS/taro/issues/5766\n      this.removeEventListener('begin', handler)\n      this.removeEventListener('end', handler)\n      return\n    }\n\n    if (!handler) {\n      return\n    }\n\n    const handlers = this.__handlers[type]\n    if (!isArray(handlers)) {\n      return\n    }\n\n    const index = handlers.findIndex(item => {\n      if (item === handler || (item as any).oldHandler === handler) return true\n    })\n\n    process.env.NODE_ENV !== 'production' && warn(index === -1, `事件: '${type}' 没有注册在 DOM 中，因此不会被移除。`)\n\n    handlers.splice(index, 1)\n  }\n\n  public isAnyEventBinded (): boolean {\n    const handlers = this.__handlers\n    const isAnyEventBinded = Object.keys(handlers).find(key => handlers[key].length)\n    return Boolean(isAnyEventBinded)\n  }\n}\n"],"names":[],"mappings":"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"}