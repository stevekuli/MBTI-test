{"version":3,"file":"next-tick.js","sources":["../src/next-tick.ts"],"sourcesContent":["import { Current } from './current'\nimport { TaroRootElement } from './dom/root'\nimport env from './env'\n\nimport type { TFunc } from './interface'\n\nconst TIMEOUT = 100\n\nexport const nextTick = (cb: TFunc, ctx?: Record<string, any>) => {\n  const beginTime = Date.now()\n  const router = Current.router\n\n  const timerFunc = () => {\n    setTimeout(function () {\n      ctx ? cb.call(ctx) : cb()\n    }, 1)\n  }\n\n  if (router === null) return timerFunc()\n\n  const path = router.$taroPath\n\n  /**\n   * 三种情况\n   *   1. 调用 nextTick 时，pendingUpdate 已经从 true 变为 false（即已更新完成），那么需要光等 100ms\n   *   2. 调用 nextTick 时，pendingUpdate 为 true，那么刚好可以搭上便车\n   *   3. 调用 nextTick 时，pendingUpdate 还是 false，框架仍未启动更新逻辑，这时最多轮询 100ms，等待 pendingUpdate 变为 true。\n   */\n  function next () {\n    const pageElement: TaroRootElement | null = env.document.getElementById<TaroRootElement>(path)\n    if (pageElement?.pendingUpdate) {\n      if (process.env.TARO_PLATFORM === 'web') {\n        // eslint-disable-next-line dot-notation\n        pageElement.firstChild?.['componentOnReady']?.().then(() => {\n          timerFunc()\n        }) ?? timerFunc()\n      } else {\n        pageElement.enqueueUpdateCallback(cb, ctx)\n      }\n    } else if (Date.now() - beginTime > TIMEOUT) {\n      timerFunc()\n    } else {\n      setTimeout(() => next(), 20)\n    }\n  }\n\n  next()\n}\n"],"names":[],"mappings":";;;AAMA,MAAM,OAAO,GAAG,GAAG,CAAA;MAEN,QAAQ,GAAG,CAAC,EAAS,EAAE,GAAyB,KAAI;AAC/D,IAAA,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;AAC5B,IAAA,MAAM,MAAM,GAAG,OAAO,CAAC,MAAM,CAAA;IAE7B,MAAM,SAAS,GAAG,MAAK;AACrB,QAAA,UAAU,CAAC,YAAA;AACT,YAAA,GAAG,GAAG,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,CAAA;SAC1B,EAAE,CAAC,CAAC,CAAA;AACP,KAAC,CAAA;IAED,IAAI,MAAM,KAAK,IAAI;QAAE,OAAO,SAAS,EAAE,CAAA;AAEvC,IAAA,MAAM,IAAI,GAAG,MAAM,CAAC,SAAS,CAAA;AAE7B;;;;;AAKG;AACH,IAAA,SAAS,IAAI,GAAA;;QACX,MAAM,WAAW,GAA2B,GAAG,CAAC,QAAQ,CAAC,cAAc,CAAkB,IAAI,CAAC,CAAA;AAC9F,QAAA,IAAI,WAAW,KAAX,IAAA,IAAA,WAAW,uBAAX,WAAW,CAAE,aAAa,EAAE;AAC9B,YAAA,IAAI,OAAO,CAAC,GAAG,CAAC,aAAa,KAAK,KAAK,EAAE;;AAEvC,gBAAA,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,WAAW,CAAC,UAAU,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAG,kBAAkB,CAAC,MAAK,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,IAAA,CAAA,EAAA,CAAA,CAAA,IAAI,CAAC,MAAK;AACzD,oBAAA,SAAS,EAAE,CAAA;AACb,iBAAC,CAAC,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,EAAA,GAAI,SAAS,EAAE,CAAA;AAClB,aAAA;AAAM,iBAAA;AACL,gBAAA,WAAW,CAAC,qBAAqB,CAAC,EAAE,EAAE,GAAG,CAAC,CAAA;AAC3C,aAAA;AACF,SAAA;aAAM,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,GAAG,OAAO,EAAE;AAC3C,YAAA,SAAS,EAAE,CAAA;AACZ,SAAA;AAAM,aAAA;YACL,UAAU,CAAC,MAAM,IAAI,EAAE,EAAE,EAAE,CAAC,CAAA;AAC7B,SAAA;KACF;AAED,IAAA,IAAI,EAAE,CAAA;AACR;;;;"}