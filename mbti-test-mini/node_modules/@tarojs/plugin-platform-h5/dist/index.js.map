{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/program.ts","../src/index.ts"],"sourcesContent":["import * as resolve from 'resolve'\n\nexport function resolveSync (id: string, opts: resolve.SyncOpts = {\n  basedir: __dirname\n}) {\n  return resolve.sync(id, opts)\n}\n","import { TaroPlatformWeb } from '@tarojs/service'\nimport path from 'path'\n\nimport { resolveSync } from './utils'\n\nimport type { IPluginContext, TConfig } from '@tarojs/service'\n\nconst compLibraryAlias = {\n  vue: 'vue2',\n  vue3: 'vue3'\n}\n\nconst PACKAGE_NAME = '@tarojs/plugin-platform-h5'\nexport default class H5 extends TaroPlatformWeb {\n  platform = 'h5'\n  runtimePath: string[] | string = `${PACKAGE_NAME}/dist/runtime`\n\n  constructor (ctx: IPluginContext, config: TConfig) {\n    super(ctx, config)\n    this.setupTransaction.addWrapper({\n      close () {\n        this.modifyWebpackConfig()\n      }\n    })\n  }\n\n  get framework () {\n    return this.ctx.initialConfig.framework || 'react'\n  }\n\n  get useHtmlComponents () {\n    return !!this.ctx.initialConfig.h5?.useHtmlComponents\n  }\n\n  get useDeprecatedAdapterComponent () {\n    return !!this.ctx.initialConfig.h5?.useDeprecatedAdapterComponent\n  }\n\n  get apiLibrary () {\n    return require.resolve('./runtime/apis')\n  }\n\n  get aliasFramework (): string {\n    return compLibraryAlias[this.framework] || 'react'\n  }\n\n  get componentLibrary () {\n    if (this.useHtmlComponents && this.aliasFramework === 'react') {\n      return require.resolve('./runtime/components')\n    } else if (this.useDeprecatedAdapterComponent) {\n      return require.resolve(`@tarojs/components/lib/${this.aliasFramework}/component-lib`)\n    } else {\n      return require.resolve(`@tarojs/components/lib/${this.aliasFramework}`)\n    }\n  }\n\n  get componentAdapter () {\n    return path.join(path.dirname(require.resolve('@tarojs/components')), '..', 'lib')\n  }\n\n  get routerLibrary () {\n    return require.resolve('@tarojs/router')\n  }\n\n  get libraryDefinition () {\n    return resolveSync('./definition.json')\n  }\n\n  /**\n   * 修改 Webpack 配置\n   */\n  modifyWebpackConfig () {\n    this.ctx.modifyWebpackChain(({ chain }) => {\n      const rules = chain.module.rules\n      const script = rules.get('script')\n      const babelLoader = script.uses.get('babelLoader')\n      babelLoader.set('options', {\n        ...babelLoader.get('options'),\n        plugins: [\n          [require('babel-plugin-transform-taroapi'), {\n            packageName: '@tarojs/taro',\n            definition: require(this.libraryDefinition)\n          }]\n        ]\n      })\n\n      const alias = chain.resolve.alias\n      // TODO 考虑集成到 taroComponentsPath 中，与小程序端对齐\n      alias.set('@tarojs/components$', this.componentLibrary)\n      alias.set('@tarojs/components/lib', this.componentAdapter)\n      alias.set('@tarojs/router$', this.routerLibrary)\n      alias.set('@tarojs/taro', this.apiLibrary)\n      chain.plugin('mainPlugin')\n        .tap(args => {\n          args[0].loaderMeta ||= {\n            extraImportForWeb: '',\n            execBeforeCreateWebApp: ''\n          }\n\n          // Note: 旧版本适配器不会自动注册 Web Components 组件，需要加载 defineCustomElements 脚本自动注册使用的组件\n          if (this.useDeprecatedAdapterComponent) {\n            args[0].loaderMeta.extraImportForWeb += `import { applyPolyfills, defineCustomElements } from '@tarojs/components/loader'\\n`\n            args[0].loaderMeta.execBeforeCreateWebApp += `applyPolyfills().then(() => defineCustomElements(window))\\n`\n          }\n\n          if (!this.useHtmlComponents) {\n            args[0].loaderMeta.extraImportForWeb += `import { defineCustomElementTaroPullToRefreshCore } from '@tarojs/components/dist/components'\\n`\n            args[0].loaderMeta.execBeforeCreateWebApp += `defineCustomElementTaroPullToRefreshCore()\\n`\n          }\n\n          switch (this.framework) {\n            case 'vue':\n              args[0].loaderMeta.extraImportForWeb += `import { initVue2Components } from '@tarojs/components/lib/vue2/components-loader'\\nimport * as list from '@tarojs/components'\\n`\n              args[0].loaderMeta.execBeforeCreateWebApp += `initVue2Components(list)\\n`\n              break\n            case 'vue3':\n              args[0].loaderMeta.extraImportForWeb += `import { initVue3Components } from '@tarojs/components/lib/vue3/components-loader'\\nimport * as list from '@tarojs/components'\\n`\n              args[0].loaderMeta.execBeforeCreateWebApp += `initVue3Components(component, list)\\n`\n              break\n            default:\n              if (this.useHtmlComponents) {\n                args[0].loaderMeta.extraImportForWeb += `import '${require.resolve('@tarojs/components-react/dist/index.css')}'\\nimport { PullDownRefresh } from '@tarojs/components'\\n`\n                args[0].loaderMeta.execBeforeCreateWebApp += `config.PullDownRefresh = PullDownRefresh\\n`\n              }\n          }\n          return args\n        })\n\n      // Note: 本地调试 stencil 组件库时，如果启用 sourceMap 则需要相关配置\n      chain.module.rule('map')\n        .test(/\\.map$/).type('json')\n    })\n  }\n}\n","import H5 from './program'\n\nimport type { IPluginContext } from '@tarojs/service'\n\n// Note: 让其它平台插件可以继承此平台\nexport { H5 }\n\nexport default (ctx: IPluginContext) => {\n  ctx.registerPlatform({\n    name: 'h5',\n    useConfigName: 'h5',\n    async fn ({ config }) {\n      const program = new H5(ctx, config)\n      await program.start()\n    }\n  })\n}\n\nexport * from './utils'\n"],"names":["resolve","TaroPlatformWeb"],"mappings":"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"}