{"version":3,"file":"download.js","sources":["../../../src/api/network/download.ts"],"sourcesContent":["import Taro from '@tarojs/api'\r\n\r\nimport { CallbackManager } from '../../utils/handler'\r\nimport { NETWORK_TIMEOUT, setHeader, XHR_STATS } from './utils'\r\n\r\nconst createDownloadTask = ({ url, header, withCredentials = true, timeout, success, error }): Taro.DownloadTask => {\r\n  let timeoutInter: ReturnType<typeof setTimeout>\r\n  const apiName = 'downloadFile'\r\n  const xhr = new XMLHttpRequest()\r\n  const callbackManager = {\r\n    headersReceived: new CallbackManager(),\r\n    progressUpdate: new CallbackManager()\r\n  }\r\n\r\n  xhr.open('GET', url, true)\r\n  xhr.withCredentials = !!withCredentials\r\n  xhr.responseType = 'blob'\r\n  setHeader(xhr, header)\r\n\r\n  xhr.onprogress = e => {\r\n    const { loaded, total } = e\r\n    callbackManager.progressUpdate.trigger({\r\n      progress: Math.round(loaded / total * 100),\r\n      totalBytesWritten: loaded,\r\n      totalBytesExpectedToWrite: total\r\n    })\r\n  }\r\n\r\n  xhr.onreadystatechange = () => {\r\n    if (xhr.readyState !== XHR_STATS.HEADERS_RECEIVED) return\r\n    callbackManager.headersReceived.trigger({\r\n      header: xhr.getAllResponseHeaders()\r\n    })\r\n  }\r\n\r\n  xhr.onload = () => {\r\n    const response = xhr.response\r\n    const status = xhr.status\r\n    success({\r\n      errMsg: `${apiName}:ok`,\r\n      statusCode: status,\r\n      tempFilePath: window.URL.createObjectURL(response)\r\n    })\r\n  }\r\n\r\n  xhr.onabort = () => {\r\n    clearTimeout(timeoutInter)\r\n    error({\r\n      errMsg: `${apiName}:fail abort`\r\n    })\r\n  }\r\n\r\n  xhr.onerror = (e: ProgressEvent<EventTarget> & { message?: string }) => {\r\n    error({\r\n      errMsg: `${apiName}:fail ${e.message}`\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 中断任务\r\n   */\r\n  const abort = () => {\r\n    xhr.abort()\r\n  }\r\n\r\n  const send = () => {\r\n    xhr.send()\r\n    timeoutInter = setTimeout(() => {\r\n      xhr.onabort = null\r\n      xhr.onload = null\r\n      xhr.onprogress = null\r\n      xhr.onreadystatechange = null\r\n      xhr.onerror = null\r\n      abort()\r\n      error({\r\n        errMsg: `${apiName}:fail timeout`\r\n      })\r\n    }, timeout || NETWORK_TIMEOUT)\r\n  }\r\n\r\n  send()\r\n\r\n  /**\r\n   * 监听 HTTP Response Header 事件。会比请求完成事件更早\r\n   * @param {HeadersReceivedCallback} callback HTTP Response Header 事件的回调函数\r\n   */\r\n  const onHeadersReceived = callbackManager.headersReceived.add\r\n  /**\r\n   * 取消监听 HTTP Response Header 事件\r\n   * @param {HeadersReceivedCallback} callback HTTP Response Header 事件的回调函数\r\n   */\r\n  const offHeadersReceived = callbackManager.headersReceived.remove\r\n\r\n  /**\r\n   * 监听进度变化事件\r\n   * @param {ProgressUpdateCallback} callback HTTP Response Header 事件的回调函数\r\n   */\r\n  const onProgressUpdate = callbackManager.progressUpdate.add\r\n  /**\r\n   * 取消监听进度变化事件\r\n   * @param {ProgressUpdateCallback} callback HTTP Response Header 事件的回调函数\r\n   */\r\n  const offProgressUpdate = callbackManager.progressUpdate.remove\r\n\r\n  return {\r\n    abort,\r\n    onHeadersReceived,\r\n    offHeadersReceived,\r\n    onProgressUpdate,\r\n    offProgressUpdate\r\n  }\r\n}\r\n\r\n/**\r\n * 下载文件资源到本地。客户端直接发起一个 HTTPS GET 请求，返回文件的本地临时路径。使用前请注意阅读相关说明。\r\n * 注意：请在服务端响应的 header 中指定合理的 Content-Type 字段，以保证客户端正确处理文件类型。\r\n */\r\nexport const downloadFile: typeof Taro.downloadFile = ({ url, header, withCredentials, timeout, success, fail, complete }) => {\r\n  let task!: Taro.DownloadTask\r\n  const result: ReturnType<typeof Taro.downloadFile> = new Promise((resolve, reject) => {\r\n    task = createDownloadTask({\r\n      url,\r\n      header,\r\n      withCredentials,\r\n      timeout,\r\n      success: res => {\r\n        success && success(res)\r\n        complete && complete(res)\r\n        resolve(res)\r\n      },\r\n      error: res => {\r\n        fail && fail(res)\r\n        complete && complete(res)\r\n        reject(res)\r\n      }\r\n    })\r\n  }) as any\r\n\r\n  result.headersReceive = task.onHeadersReceived.bind(task)\r\n  result.progress = task.onProgressUpdate.bind(task)\r\n\r\n  const properties = {}\r\n  Object.keys(task).forEach(key => {\r\n    properties[key] = {\r\n      get () {\r\n        return typeof task[key] === 'function' ? task[key].bind(task) : task[key]\r\n      }\r\n    }\r\n  })\r\n  return Object.defineProperties(result, properties)\r\n}\r\n"],"names":[],"mappings":"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"}