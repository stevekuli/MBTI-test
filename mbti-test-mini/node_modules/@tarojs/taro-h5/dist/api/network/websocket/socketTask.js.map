{"version":3,"file":"socketTask.js","sources":["../../../../src/api/network/websocket/socketTask.ts"],"sourcesContent":["import Taro from '@tarojs/api'\nimport { isFunction } from '@tarojs/shared'\n\nexport class SocketTask {\n  ws: WebSocket\n  CONNECTING: number\n  OPEN: number\n  CLOSING: number\n  CLOSED: number\n  closeDetail: { code: any, reason: any }\n  _destroyWhenClose?: () => void\n\n  constructor (url, protocols) {\n    if (protocols && protocols.length) {\n      this.ws = new WebSocket(url, protocols)\n    } else {\n      this.ws = new WebSocket(url)\n    }\n    this.CONNECTING = 0\n    this.OPEN = 1\n    this.CLOSING = 2\n    this.CLOSED = 3\n  }\n\n  get readyState () {\n    return this.ws.readyState\n  }\n\n  send (opts: Partial<Taro.SocketTask.SendOption> = {}) {\n    if (typeof opts !== 'object' || !opts) opts = {}\n\n    const { data = '', success, fail, complete } = opts\n\n    if (this.readyState !== 1) {\n      const res = { errMsg: 'SocketTask.send:fail SocketTask.readState is not OPEN' }\n      console.error(res.errMsg)\n      isFunction(fail) && fail(res)\n      isFunction(complete) && complete(res)\n      return Promise.reject(res)\n    }\n\n    this.ws.send(data)\n\n    const res = { errMsg: 'sendSocketMessage:ok' }\n    isFunction(success) && success(res)\n    isFunction(complete) && complete(res)\n    return Promise.resolve(res)\n  }\n\n  close (opts: Partial<Taro.SocketTask.CloseOption> = {}) {\n    if (typeof opts !== 'object' || !opts) opts = {}\n\n    const {\n      code = 1000,\n      reason = 'server complete,close',\n      success,\n      complete\n    } = opts\n\n    this.closeDetail = { code, reason }\n    // 主动断开时需要重置链接数\n    this._destroyWhenClose && this._destroyWhenClose()\n    this.ws.close()\n\n    const res = { errMsg: 'closeSocket:ok' }\n    isFunction(success) && success(res)\n    isFunction(complete) && complete(res)\n    return Promise.resolve(res)\n  }\n\n  onOpen (func) {\n    this.ws.onopen = func\n  }\n\n  onMessage (func) {\n    this.ws.onmessage = func\n  }\n\n  onClose (func) {\n    this.ws.onclose = () => {\n      // 若服务器方断掉也需要重置链接数\n      this._destroyWhenClose && this._destroyWhenClose()\n      func(this.closeDetail || { code: 1006, reason: 'abnormal closure' })\n    }\n  }\n\n  onError (func) {\n    this.ws.onerror = func\n  }\n}\n"],"names":[],"mappings":"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"}