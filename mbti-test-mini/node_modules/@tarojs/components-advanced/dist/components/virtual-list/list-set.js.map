{"version":3,"file":"list-set.js","sources":["../../../src/components/virtual-list/list-set.ts"],"sourcesContent":["import { isFunction } from '@tarojs/shared'\nimport memoizeOne from 'memoize-one'\n\nimport { getOffsetForIndexAndAlignment } from '../../utils'\nimport { isHorizontalFunc } from './utils'\n\nimport type { IProps } from './preset'\n\ntype TProps = Pick<IProps, 'width' | 'height' | 'unlimitedSize' | 'itemCount' | 'itemData' | 'itemSize' | 'overscanCount' | 'direction' | 'layout'>\n\nexport default class ListSet {\n  list: number[] = []\n  mode?: 'normal' | 'function' | 'unlimited'\n  defaultSize = 1\n\n  wrapperHeight = 0\n  wrapperWidth = 0\n\n  refreshCounter = 0\n\n  constructor (protected props: TProps, protected refresh?: TFunc) {\n    this.update(props)\n\n    // Note: 不考虑列表模式切换情况，可能会导致列表抖动体验过差\n    if (this.props.unlimitedSize) {\n      this.mode = 'unlimited'\n    } else if (isFunction(this.props.itemSize)) {\n      this.mode = 'function'\n    } else {\n      this.mode = 'normal'\n    }\n\n    this.defaultSize = (isFunction(this.props.itemSize) ? this.props.itemSize() : this.props.itemSize) || 1\n\n    if (!this.isNormalMode) {\n      this.list = new Array(this.length).fill(-1)\n    }\n  }\n\n  get isNormalMode () {\n    return this.mode === 'normal'\n  }\n\n  get isFunctionMode () {\n    return this.mode === 'function'\n  }\n\n  get isUnlimitedMode () {\n    return this.mode === 'unlimited'\n  }\n\n  get length () {\n    return this.props.itemCount || 100\n  }\n\n  get overscan () {\n    return this.props.overscanCount || 0\n  }\n\n  get wrapperSize () {\n    return isHorizontalFunc(this.props) ? this.wrapperWidth : this.wrapperHeight\n  }\n\n  update (props: TProps) {\n    this.props = props\n\n    if (this.length > this.list.length) {\n      const arr = new Array(this.length - this.list.length).fill(-1)\n      this.list.push(...arr)\n    } else if (this.length < this.list.length) {\n      this.list.length = this.length\n    }\n  }\n\n  setSize (i = 0, size = this.defaultSize) {\n    this.list[i] = size\n    this.refresh?.()\n    this.refreshCounter++\n  }\n\n  getSize (i = 0) {\n    const size = this.props.itemSize\n    const item = this.list[i]\n    if (item >= 0) return item\n\n    if (this.isFunctionMode && isFunction(size)) {\n      const itemSize = size(i, this.props.itemData)\n      this.setSize(i, itemSize)\n      return itemSize\n    }\n    return this.defaultSize\n  }\n\n  getOffsetSize (i = this.list.length) {\n    if (this.isNormalMode) return i * this.defaultSize\n    return this.list.slice(0, i).reduce((sum, _, idx) => sum + this.getSize(idx), 0)\n  }\n\n  getOffsetSizeCache = memoizeOne((i = this.list.length, _flag = this.refreshCounter) => {\n    return this.getOffsetSize(i)\n  })\n\n  getSizeCount (offset = 0) {\n    if (offset === 0) return 0\n    // if (this.isNormalMode) {\n    //   return Math.min(this.length - 1, Math.floor(offset / this.length))\n    // }\n    let offsetSize = 0\n    const count = this.list.reduce((sum, _, idx) => {\n      if (offsetSize < offset) {\n        offsetSize += this.getSize(idx)\n        return ++sum\n      }\n      return sum\n    }, 0)\n    return count - 1\n  }\n\n  getStartIndex (scrollOffset = 0) {\n    return Math.max(0, this.getSizeCount(scrollOffset) - 1)\n  }\n\n  getStopIndex (wrapperSize = 0, scrollOffset = 0, startIndex = 0) {\n    // const visibleOffset = this.getOffsetSizeCache(startIndex)\n    // if (this.isNormalMode) {\n    //   const numVisibleItems = Math.ceil((wrapperSize + scrollOffset - visibleOffset) / this.length)\n    //   /** -1 is because stop index is inclusive */\n    //   return Math.max(startIndex, Math.min(this.length - 1, startIndex + numVisibleItems - 1))\n    // }\n    return Math.max(startIndex, Math.min(this.length - 1, this.getSizeCount(wrapperSize + scrollOffset)))\n  }\n\n  getRangeToRender (direction: 'forward' | 'backward', scrollOffset = 0, block = false) {\n    if (this.length === 0) {\n      return [0, 0, 0, 0]\n    }\n\n    const startIndex = this.getStartIndex(scrollOffset)\n    const stopIndex = this.getStopIndex(this.wrapperSize, scrollOffset, startIndex)\n\n    // Overscan by one item in each direction so that tab/focus works. If there isn't at least one extra item, tab loops back around.\n    const overscanBackward = !block || direction === 'backward' ? Math.max(1, this.overscan) : 1\n    const overscanForward = !block || direction === 'forward' ? Math.max(1, this.overscan) : 1\n    return [\n      Math.max(0, startIndex - overscanBackward),\n      Math.max(0, Math.min(this.length - 1, stopIndex + overscanForward)),\n      startIndex,\n      stopIndex\n    ]\n  }\n\n  getOffsetForIndexAndAlignment (index: number, align: string, scrollOffset: number) {\n    return getOffsetForIndexAndAlignment({\n      align,\n      containerSize: this.wrapperSize,\n      currentOffset: scrollOffset,\n      scrollSize: this.getOffsetSizeCache(this.length),\n      slideSize: this.getSize(index),\n      targetOffset: this.getOffsetSizeCache(index),\n    })\n  }\n\n  compareSize (i = 0, size = this.defaultSize) {\n    if (this.isNormalMode) return true\n    return this.getSize(i) === size\n  }\n}\n"],"names":[],"mappings":"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"}