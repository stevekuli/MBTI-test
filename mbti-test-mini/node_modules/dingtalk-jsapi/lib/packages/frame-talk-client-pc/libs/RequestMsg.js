"use strict";var msgIdSeq=0,msgIdSalt=Math.floor(1e3*Math.random()),genMsgId=function(){return 1e3*(1e3*msgIdSalt+Math.floor(1e3*Math.random()))+ ++msgIdSeq%1e3},TIMEOUT_MSG={code:408,reason:"timeout"},EVENTS_NAME={TIMEOUT:"_timeout",FINISH:"_finish"},defaultOption={timeout:-1},RequestMsg=function(t,e,i,s){this.id=genMsgId(),this.methodName=e,this.containerId=t,this.option=Object.assign({},defaultOption,s);var i=i||{};this._p={},this.result=new Promise(function(t,e){this._p._resolve=t,this._p._reject=e}.bind(this)),this.callbacks={},this.plainMsg=this._handleMsg(i),this._eventsHandle={},this._timeoutTimer=null,this._initTimeout(),this.isFinish=!1};RequestMsg.prototype._initTimeout=function(){this._clearTimeout(),this.option.timeout>0&&(this._timeoutTimer=setTimeout(function(){this.receiveEvent(EVENTS_NAME.TIMEOUT),this.receiveResponse(TIMEOUT_MSG,!0)}.bind(this),this.option.timeout))},RequestMsg.prototype._clearTimeout=function(){clearTimeout(this._timeoutTimer)},RequestMsg.prototype._handleMsg=function(t){var e={};return Object.keys(t).forEach(function(i){var s=t[i];"function"==typeof s&&"on"===i.slice(0,2)?this.callbacks[i]=s:e[i]=s}.bind(this)),e},RequestMsg.prototype.getPayload=function(){return{msgId:this.id,containerId:this.containerId,methodName:this.methodName,body:this.plainMsg,type:"request"}},RequestMsg.prototype.receiveEvent=function(t,e){if(this.isFinish&&t!==EVENTS_NAME.FINISH)return!1;t!==EVENTS_NAME.FINISH&&t!==EVENTS_NAME.TIMEOUT&&this._initTimeout(),Array.isArray(this._eventsHandle[t])&&this._eventsHandle[t].forEach(function(t){try{t(e)}catch(t){console.error(e)}});var i="on"+t.charAt(0).toUpperCase()+t.slice(1);return this.callbacks[i]&&this.callbacks[i](e),!0},RequestMsg.prototype.addEventListener=function(t,e){if(!t||"function"!=typeof e)throw"eventName is null or handle is not a function, addEventListener fail";Array.isArray(this._eventsHandle[t])||(this._eventsHandle[t]=[]),this._eventsHandle[t].push(e)},RequestMsg.prototype.removeEventListener=function(t,e){if(!t||!e)throw"eventName is null or handle is null, invoke removeEventListener fail";if(Array.isArray(this._eventsHandle[t])){var i=this._eventsHandle[t].indexOf(e);-1!==i&&this._eventsHandle[t].splice(i,1)}},RequestMsg.prototype.receiveResponse=function(t,e){if(!0===this.isFinish)return!1;this._clearTimeout();var e=!!e;return e?this._p._reject(t):this._p._resolve(t),setTimeout(function(){this.receiveEvent(EVENTS_NAME.FINISH)}.bind(this),0),this.isFinish=!0,!0},module.exports=RequestMsg;